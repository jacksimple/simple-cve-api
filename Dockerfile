FROM python:3.8-alpine as base

FROM base as builder
RUN apk add --no-cache --virtual .build-deps gcc libc-dev make git
COPY requirements.txt /requirements.txt
RUN pip install --install-option="--prefix=/install" -r /requirements.txt
# fastapi seems to ignore the prefix flag
RUN cp -r /usr/local/lib/python3.8/site-packages/fastapi /install/lib/python3.8/site-packages/

# build sqlite db
RUN mkdir /db_builder
WORKDIR /db_builder
# I tried using submodules, but syncing was a pain.  I just git clone now
# COPY ./cvelist /db_builder/cvelist
RUN git clone https://github.com/CVEProject/cvelist
COPY dbgen.py /db_builder/dbgen.py
RUN python dbgen.py

FROM base
RUN mkdir /app
COPY main.py /app
COPY --from=builder /install /usr/local
COPY --from=builder /db_builder/cves.db /app/cves.db
WORKDIR /app
CMD ["uvicorn", "main:app", "--host",  "0.0.0.0"]
